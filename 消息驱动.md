## 概述
使用spring-cloud-stream模块，中间件使用rabbit，实现微服务间基于消息驱动。
## 消息生产者
### 定义消息输出通道
新建消息输出通道定义接口(如`EspSource`)
```java
public interface EspSource {
  String OUTPUT = "espOutput";

  /**
  * 消息输出通道
  *
  * @return 消息输出通道
  */
  @Output(OUTPUT)
  MessageChannel  output();
}
```
### 环境变量
新建类配置文件扩展类（如`EspClientStreamEnvironmentPostProcessor`），实现`EnvironmentPostProcessor`接口。
```java
public class EspClientStreamEnvironmentPostProcessor implements EnvironmentPostProcessor {
  @Override
  public void postProcessEnvironment(ConfigurableEnvironment  environment, SpringApplication  application) {
    Map defaults = new  HashMap<>(2);
    defaults.put("spring.cloud.stream.bindings." + EspSource.OUTPUT + ".content-type",MediaType.APPLICATION_JSON_VALUE);
    defaults.put("spring.cloud.stream.bindings." + EspSource.OUTPUT + ".destination", "espTopic");
    EnvironmentUtils.addOrReplace(environment, defaults, "springCloudStreamCustomProperties");
  }
}
```
在src/main/resources/META-INF下创建spring.factories，并且引入配置文件扩展类。
```
org.springframework.boot.env.EnvironmentPostProcessor=\
com.casic.cplm.esp.stream.EspClientStreamEnvironmentPostProcessor
```

### 消息消费者
### 定义消息输入通道
```java
public  interface  EspSink {
  String INPUT = "espInput";
  /**
  * 消息输入通道
  *
  * @return 消息输入通道
  */
  @Input(INPUT)
  SubscribableChannel  input();
}
```
建立输入、输出通道，如上代码所示。

定义rabbit变量，配置输出、输入信息

```java
espSource.output().send(MessageBuilder.withPayload(jsonMap).build());
```
发送信息如上代码所示。
```java
@StreamListener(EspSink.INPUT)
public  void  receiveMessage(Message> message) {

}
```
接受信息处理。
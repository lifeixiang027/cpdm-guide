## 概述

## 实现原理及示例

### 新建注解类
注解在Java中，与类、接口、枚举类似，因此其声明语法基本一致，只是所使用的关键字有所不同`@interface`。**在底层实现上，所有定义的注解都会自动继承java.lang.annotation.Annotation接口**。

注解类型的实现部分：

根据我们在自定义类的经验，在类的实现部分无非就是书写构造、属性或方法。但是，在自定义注解中，其实现部分**只能定义**一个东西：**注解类型元素（annotation type element）**。

定义注解类型元素时需要注意如下几点：
1. 访问修饰符必须为public，不写默认为public；
2. 该元素的类型只能是基本数据类型、String、Class、枚举类型、注解类型（体现了注解的嵌套效果）以及上述类型的一位数组；
3. 该元素的名称一般定义为名词，如果注解中只有一个元素，请把名字起为value（后面使用会带来便利操作）；
4. ()不是定义方法参数的地方，也不能在括号中定义任何参数，仅仅只是一个特殊的语法；
5. default代表默认值，值必须和第2点定义的类型一致；
6. 如果没有默认值，代表后续使用注解时必须给该类型元素赋值。
```java
import java.lang.annotation.Documented;
import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface ScheduledTask {
  /** 任务名称 */
  String name();

  String group();

  /** 任务描述 */
  String description();

  /** 执行周期 */
  String scheduleRate();

  /** 定时表达式 */
  String cron();

  /** 自定义参数 */
  String params();

  /** 失败重试次数 */
  int failureNum();

  /** 失败重试间隔 */
  int failureInterval();
}
```

新建后置处理器（BeanPostProcessor）
```java
import java.util.Objects;
import org.springframework.aop.framework.AopProxyUtils;
import org.springframework.beans.factory.config.BeanPostProcessor;
import org.springframework.core.annotation.AnnotationUtils;

public class ScheduledTaskBeanPostProcessor implements BeanPostProcessor {

  @Override
  public Object postProcessAfterInitialization(Object bean, String beanName) {
    Class<?> targetClass = AopProxyUtils.ultimateTargetClass(bean);
    //    获取自定义注解
    ScheduledTask annotation = AnnotationUtils.getAnnotation(targetClass, ScheduledTask.class);
    //    如果自定义注解不为空，则表示此类被注解
    if (Objects.nonNull(annotation)) {
      //     从注解中获取属性，进行后续处理

    }
    return bean;
  }
}
```
新建导入类（ImportSelector）
```java
import org.springframework.context.annotation.ImportSelector;
import org.springframework.core.type.AnnotationMetadata;
import org.springframework.lang.NonNull;

 public class ScheduledTaskImportSelector implements ImportSelector {

  @NonNull
  @Override
  public String[] selectImports(AnnotationMetadata annotationMetadata) {
    return new String[] {ScheduledTaskBeanPostProcessor.class.getName()};
  }
 }
```
新建Enable*注解
```java
import java.lang.annotation.Documented;
import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;
import org.springframework.context.annotation.Import;

@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Import(ScheduledTaskImportSelector.class)
@Documented
public @interface EnableScheduledTask {}
```

